name: Test Suite

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œæµ‹è¯•å¥—ä»¶
    - cron: '0 2 * * *'

jobs:
  # è¿è¡Œå•å…ƒæµ‹è¯•
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy, rustfmt
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-test-${{ hashFiles('tests/Cargo.lock') }}
    
    - name: Run unit tests
      run: |
        cd tests
        cargo test --lib --verbose
    
    - name: Upload unit test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: unit-test-results
        path: tests/target/nightly/
        retention-days: 7

  # è¿è¡Œé›†æˆæµ‹è¯•
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-test-${{ hashFiles('tests/Cargo.lock') }}
    
    - name: Run integration tests
      run: |
        cd tests
        cargo test --test integration_tests --verbose
    
    - name: Upload integration test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: integration-test-results
        path: tests/reports/
        retention-days: 7

  # è¿è¡ŒE2Eæµ‹è¯•
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install Git
      run: |
        sudo apt-get update
        sudo apt-get install -y git
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-test-${{ hashFiles('tests/Cargo.lock') }}
    
    - name: Run E2E tests
      run: |
        cd tests
        cargo test --test e2e_tests --verbose -- --nocapture
    
    - name: Upload E2E test results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: e2e-test-results
        path: tests/reports/
        retention-days: 7

  # è¿è¡Œæ€§èƒ½æµ‹è¯•
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-test-${{ hashFiles('tests/Cargo.lock') }}
    
    - name: Run performance benchmarks
      run: |
        cd tests
        cargo bench --verbose
    
    - name: Upload performance results
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-results
        path: |
          tests/target/criterion/
          tests/reports/
        retention-days: 7

  # éªŒè¯GitHub Actionså·¥ä½œæµ
  validate-workflows:
    name: Validate Workflows
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-test-${{ hashFiles('tests/Cargo.lock') }}
    
    - name: Build validation tools
      run: |
        cd tests
        cargo build --release
    
    - name: Validate CI workflow
      run: |
        cd tests
        ./target/release/validate_workflow ../.github/workflows/ci.yml
    
    - name: Validate release workflow
      run: |
        cd tests
        ./target/release/validate_workflow ../.github/workflows/release.yml
    
    - name: Validate security workflow
      run: |
        cd tests
        ./target/release/validate_workflow ../.github/workflows/security-scan.yml
    
    - name: Upload validation reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: workflow-validation-reports
        path: |
          tests/*_validation_report.md
          tests/reports/
        retention-days: 7

  # è¿è¡Œå®‰å…¨æµ‹è¯•
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-test-${{ hashFiles('tests/Cargo.lock') }}
    
    - name: Build security tools
      run: |
        cd tests
        cargo build --release
    
    - name: Test CI workflow security
      run: |
        cd tests
        ./target/release/security_test ../.github/workflows/ci.yml --output-format json
    
    - name: Test release workflow security
      run: |
        cd tests
        ./target/release/security_test ../.github/workflows/release.yml --output-format json
    
    - name: Test security workflow security
      run: |
        cd tests
        ./target/release/security_test ../.github/workflows/security-scan.yml --output-format json
    
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-test-reports
        path: |
          tests/*_security_report.*
          tests/reports/
        retention-days: 7

  # è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, e2e-tests, performance-tests, validate-workflows, security-tests]
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v3
    
    - name: Run comprehensive test script
      run: |
        chmod +x tests/scripts/run_tests.sh
        tests/scripts/run_tests.sh
    
    - name: Generate comprehensive report
      run: |
        echo "# Comprehensive Test Suite Report" > comprehensive-report.md
        echo "" >> comprehensive-report.md
        echo "## Test Execution Summary" >> comprehensive-report.md
        echo "" >> comprehensive-report.md
        echo "- **Unit Tests:** $([ -f unit-test-results ] && echo "âœ… PASSED" || echo "âŒ FAILED")" >> comprehensive-report.md
        echo "- **Integration Tests:** $([ -f integration-test-results ] && echo "âœ… PASSED" || echo "âŒ FAILED")" >> comprehensive-report.md
        echo "- **E2E Tests:** $([ -f e2e-test-results ] && echo "âœ… PASSED" || echo "âŒ FAILED")" >> comprehensive-report.md
        echo "- **Performance Tests:** $([ -f performance-results ] && echo "âœ… COMPLETED" || echo "âŒ FAILED")" >> comprehensive-report.md
        echo "- **Workflow Validation:** $([ -f workflow-validation-reports ] && echo "âœ… PASSED" || echo "âŒ FAILED")" >> comprehensive-report.md
        echo "- **Security Tests:** $([ -f security-test-reports ] && echo "âœ… PASSED" || echo "âŒ FAILED")" >> comprehensive-report.md
        echo "" >> comprehensive-report.md
        echo "## Execution Details" >> comprehensive-report.md
        echo "" >> comprehensive-report.md
        echo "**Run Date:** $(date)" >> comprehensive-report.md
        echo "**Commit:** ${{ github.sha }}" >> comprehensive-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> comprehensive-report.md
        echo "**Workflow:** ${{ github.workflow }}" >> comprehensive-report.md
        echo "" >> comprehensive-report.md
        echo "---" >> comprehensive-report.md
        echo "*Generated by GitHub Actions Test Suite*" >> comprehensive-report.md
    
    - name: Upload comprehensive report
      uses: actions/upload-artifact@v3
      with:
        name: comprehensive-test-report
        path: |
          comprehensive-report.md
          tests/reports/
        retention-days: 30

  # ç”Ÿæˆæµ‹è¯•æ‘˜è¦
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: full-test-suite
    if: always()
    
    steps:
    - name: Download comprehensive report
      uses: actions/download-artifact@v3
      with:
        name: comprehensive-test-report
    
    - name: Comment PR with test results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('comprehensive-report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ğŸ§ª Test Suite Results\n\n${report}`
          });
    
    - name: Set test status
      if: always()
      run: |
        if [ -f "comprehensive-report.md" ]; then
          echo "âœ… Test suite completed successfully"
        else
          echo "âŒ Test suite failed"
          exit 1
        fi